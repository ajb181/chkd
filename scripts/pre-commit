#!/bin/bash

# Auto-bump version when MCP or API files change
# Install: ln -sf ../../scripts/pre-commit .git/hooks/pre-commit

# Check if any MCP or API files are staged
CHANGED_FILES=$(git diff --cached --name-only)

if echo "$CHANGED_FILES" | grep -qE '^src/mcp/|^src/routes/api/'; then
  echo "ðŸ“¦ MCP/API files changed - bumping version..."
  
  # Read current version from package.json
  CURRENT_VERSION=$(node -p "require('./package.json').version")
  
  # Bump patch version
  IFS='.' read -ra PARTS <<< "$CURRENT_VERSION"
  MAJOR="${PARTS[0]}"
  MINOR="${PARTS[1]}"
  PATCH="${PARTS[2]}"
  NEW_PATCH=$((PATCH + 1))
  NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
  
  echo "   $CURRENT_VERSION â†’ $NEW_VERSION"
  
  # Update package.json
  node -e "
    const fs = require('fs');
    const pkg = JSON.parse(fs.readFileSync('package.json', 'utf-8'));
    pkg.version = '$NEW_VERSION';
    fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
  "
  
  # Update SERVER_VERSION in server-http.ts
  sed -i '' "s/const SERVER_VERSION = \".*\"/const SERVER_VERSION = \"$NEW_VERSION\"/" src/mcp/server-http.ts
  
  # Stage the updated files
  git add package.json src/mcp/server-http.ts
  
  echo "âœ… Version bumped to $NEW_VERSION"
fi
